<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced PDF Cropper</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 10px;
  }
  #pdfCanvas {
    border: 1px solid #ccc;
  }
  #cropBtn {
    margin-top: 15px;
    padding: 10px 20px;
    background: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 5px;
  }
</style>
</head>
<body>

<h2>PDF Cropper (Drag & Resize)</h2>
<input type="file" id="pdfFile" accept="application/pdf">
<br><br>
<canvas id="pdfCanvas"></canvas>
<br>
<button id="cropBtn">Crop & Download</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<script>
const fileInput = document.getElementById('pdfFile');
const canvasEl = document.getElementById('pdfCanvas');
const ctx = canvasEl.getContext('2d');
let pdfDoc, page, viewport;
let fabricCanvas;
let cropRect;

fileInput.addEventListener('change', async () => {
  const file = fileInput.files[0];
  if (!file) return;

  const arrayBuffer = await file.arrayBuffer();
  const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
  pdfDoc = await loadingTask.promise;
  page = await pdfDoc.getPage(1);

  viewport = page.getViewport({ scale: 1.5 });
  canvasEl.width = viewport.width;
  canvasEl.height = viewport.height;

  const renderContext = {
    canvasContext: ctx,
    viewport: viewport
  };
  await page.render(renderContext).promise;

  // Fabric overlay
  if (fabricCanvas) fabricCanvas.dispose();
  fabricCanvas = new fabric.Canvas('pdfCanvas', { selection: false });

  // Create draggable, resizable crop rectangle
  cropRect = new fabric.Rect({
    left: 50,
    top: 50,
    width: 200,
    height: 150,
    fill: 'rgba(255, 0, 0, 0.2)',
    stroke: 'red',
    strokeWidth: 2,
    hasRotatingPoint: false,
    lockRotation: true
  });
  fabricCanvas.add(cropRect);
});
 
document.getElementById('cropBtn').addEventListener('click', async () => {
  if (!pdfDoc || !cropRect) return;

  const originalPDFBytes = await fileInput.files[0].arrayBuffer();
  const pdfDocLib = await PDFLib.PDFDocument.load(originalPDFBytes);
  const pdfPage = pdfDocLib.getPage(0);

  const scale = 1.5;

  const cropX = cropRect.left / scale;
  const cropY = (viewport.height - cropRect.top - cropRect.height) / scale;
  const cropWidth = cropRect.width / scale;
  const cropHeight = cropRect.height / scale;

  pdfPage.setCropBox(cropX, cropY, cropWidth, cropHeight);

  const croppedPDF = await pdfDocLib.save();
  const blob = new Blob([croppedPDF], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'cropped.pdf';
  a.click();
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
